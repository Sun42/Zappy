#include <stdio.h>
#include "buffer.h"
/*
** ajoute un text au buffer, penser a faire un can_add
** return values
** 1 ajoute en fin de buffer
** 2 ajoute en debut de buffer
** 3 ajoute en liste chainee tampon
** -1 pas pu etre ajoutee (liste chainee > 10)
*/

static void	add_begbuf(t_buf *my_buf, char *text, int len);
static int	add_endbuf(t_buf *my_buf, char *text, int len);
static int	can_add_endbuf(t_buf *my_buf, int len);
static int	can_add_begbuf(t_buf *my_buf, int len);

/*
** ajoute dans le buffer et retourne l'indice_buf
** 0 =>add begin_buffer, -1 ajout en malloc car buffer full
*/
int	add_buf(t_cli *my_cli, char *text, int len)
{
  int	indice_buf;

  if (can_add_endbuf(my_cli->bufr, len))
    {
      indice_buf = add_endbuf(my_cli->bufr, text, len);
      printf("add_end buffer, %s \n", text);
      return (indice_buf);
    }
  my_cli->bufr->end = 0;
  if (can_add_begbuf(my_cli->bufr, len))
    {
      add_begbuf(my_cli->bufr, text, len);
      printf("add_begin buffer, %s \n", text);
      return (0);
    }
  /* ajouter en malloc*/
    
  printf("Error add_buf pas encore fait, %s \n", text);
  return (-1);
}

/*
**ajoute en debut de buffer
*/
static void     add_begbuf(t_buf *my_buf, char *text, int len)
{
  int   i;

  i = my_buf->end;
  while (i < len)
    {
      my_buf->buf[i] = text[i];
      i++;
    }
  my_buf->end = i - 1;
}

/*
** ajoute en fin de buffer (a la suite)
** retourne lindice de debut dajout soit lancien my_buf->end 
*/
  static int	add_endbuf(t_buf *my_buf, char *text, int len)
{
  int		cpt;
  int		end;
  int		ret;
  
  cpt = 0;
  ret = end = my_buf->end;
  while (cpt < len)
    {
      if (end == BUF_SIZE)
        end = 0;
      my_buf->buf[end] = text[cpt];
      cpt++;
      end++;
    }
  if (end == BUF_SIZE)
    my_buf->end = 0;
  else
    my_buf->end = end;
  return (ret);
}
/*
** bool assez de place dans la fin du buffer ?
** checker aussi si end nempiete pas sur begin
*/
static int	can_add_endbuf(t_buf *my_buf, int len)
{
  if ((BUF_SIZE - my_buf->end) < len)
    return (0);
  if ((my_buf->buf[my_buf->end] == '0') && (my_buf->end >= my_buf->begin))
    return (1);
  return (0);
}

/*
** bool peut-on placer le text en debut de buffer ?
*/
static int	can_add_begbuf(t_buf *my_buf, int len)
{
  int		i;

  if (BUF_SIZE < len)
    return (0);
  if (len > my_buf->begin)
    return (0);
  i = my_buf->end;;
  while (i < len)
    {
      if (my_buf->buf[i] != '0')
        return (0);
    }
  return (1);
}

